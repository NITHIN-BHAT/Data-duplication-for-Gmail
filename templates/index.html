<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gmail Deduplicator</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    button { padding: 10px 15px; font-size: 16px; }
    #log { margin-top: 20px; white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; }
  </style>
</head>
<body>
  <h1>Gmail Deduplicator</h1>

  {% if signed_in %}
    <p>You're signed in. Click below to scan and delete duplicates.</p>
    <button id="run">Scan & Delete Duplicates</button>
    <a href="/signout" style="margin-left:10px;">Sign out</a>
  {% else %}
    <p>You are not signed in.</p>
    <a href="/authorize"><button>Sign in with Google</button></a>
  {% endif %}

  <div id="log"></div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const log = (txt) => {
    const el = document.getElementById("log");
    el.textContent = txt + "\n\n" + el.textContent;
  };

  const runBtn = document.getElementById("run");
  if (runBtn) {
    runBtn.addEventListener("click", async () => {
      runBtn.disabled = true;
      runBtn.textContent = "Scanning...";
      log("Starting deduplication...");

      try {
        const res = await fetch("/dedupe", { method: "POST" });
        if (!res.ok) {
          const err = await res.json();
          log("Error: " + (err.error || JSON.stringify(err)));
          runBtn.disabled = false;
          runBtn.textContent = "Scan & Delete Duplicates";
          return;
        }
        const data = await res.json();
        log("Done.\nDeleted count: " + data.deleted_count +
            "\nDuplicates found: " + data.duplicates_found +
            "\nUnique emails scanned: " + data.unique_emails);
      } catch (e) {
        log("Network error: " + e);
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = "Scan & Delete Duplicates";
      }
    });
  }
});
</script>
</body>
</html>
